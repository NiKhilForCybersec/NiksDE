<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qualys Deep Dive | Detection Engineering Mastery</title>
    <link rel="stylesheet" href="../../css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon">DE</div>
                    <span class="logo-text">Detection Engineering</span>
                </div>
                <button class="sidebar-toggle" aria-label="Toggle Sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
            </div>
            
            <div class="sidebar-search">
                <input type="text" class="search-input" placeholder="Search topics...">
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section" data-section="home">
                    <a href="../../index.html" class="nav-section-header" style="text-decoration: none;">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            <span>Home</span>
                        </div>
                    </a>
                </div>

                <div class="nav-section" data-section="detection">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            <span>Detection Engineering</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <div class="nav-items">
                        <a href="../detection-engineering/fundamentals.html" class="nav-item">Detection Fundamentals</a>
                        <a href="../detection-engineering/sentinel-deep-dive.html" class="nav-item">Microsoft Sentinel Deep Dive</a>
                        <a href="../detection-engineering/splunk-comparison.html" class="nav-item">Splunk Comparison</a>
                    </div>
                </div>

                <div class="nav-section active expanded" data-section="vuln">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            <span>Vulnerability Management</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <div class="nav-items">
                        <a href="fundamentals.html" class="nav-item">VM Fundamentals</a>
                        <a href="qualys-deep-dive.html" class="nav-item active">Qualys Deep Dive</a>
                        <a href="tenable-nessus.html" class="nav-item">Tenable/Nessus</a>
                        <a href="risk-prioritization.html" class="nav-item">Risk Prioritization</a>
                        <a href="remediation.html" class="nav-item">Remediation Workflows</a>
                    </div>
                </div>

                <div class="nav-section" data-section="sap">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                <line x1="8" y1="21" x2="16" y2="21"></line>
                                <line x1="12" y1="17" x2="12" y2="21"></line>
                            </svg>
                            <span>SAP Security</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <div class="nav-items">
                        <a href="../sap-security/sap-overview.html" class="nav-item">What is SAP?</a>
                        <a href="../sap-security/architecture.html" class="nav-item">SAP Architecture</a>
                        <a href="../sap-security/threat-detection.html" class="nav-item">Threat Detection</a>
                    </div>
                </div>

                <div class="nav-section" data-section="reference">
                    <div class="nav-section-header">
                        <div class="nav-section-title">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                            <span>Quick Reference</span>
                        </div>
                        <svg class="nav-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                    <div class="nav-items">
                        <a href="../references/kql-cheatsheet.html" class="nav-item">KQL Cheat Sheet</a>
                        <a href="../references/spl-cheatsheet.html" class="nav-item">SPL Cheat Sheet</a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <div class="breadcrumb">
                    <a href="../../index.html" class="breadcrumb-item">Home</a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">Vulnerability Management</span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item active">Qualys Deep Dive</span>
                </div>
            </header>

            <div class="page-content">
                <h1>Qualys Deep Dive</h1>
                <p style="font-size: 1.125rem; color: var(--text-secondary); max-width: 800px;">
                    Master Qualys VMDR - from Cloud Agents to API integration, Policy Compliance, Container Security, 
                    and building a comprehensive vulnerability management program.
                </p>

                <!-- Qualys Platform Overview -->
                <h2>Qualys Platform Overview</h2>

                <p>Qualys is a cloud-based security and compliance platform. Unlike on-premise scanners, Qualys operates entirely from the cloud with lightweight agents or network scanners deployed in your environment.</p>

                <div class="info-box info">
                    <strong>Platform Architecture:</strong> Qualys operates multiple cloud platforms (US1, US2, US3, EU, etc.). 
                    Your subscription determines which platform hosts your data. API endpoints differ by platform.
                </div>

                <h3>Core Modules</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Module</th>
                            <th>Purpose</th>
                            <th>Key Features</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>VMDR</strong></td>
                            <td>Vulnerability Management, Detection & Response</td>
                            <td>Vulnerability scanning, TruRisk scoring, remediation tracking</td>
                        </tr>
                        <tr>
                            <td><strong>Policy Compliance (PC)</strong></td>
                            <td>Configuration assessment</td>
                            <td>CIS benchmarks, custom policies, compliance reporting</td>
                        </tr>
                        <tr>
                            <td><strong>Web Application Scanning (WAS)</strong></td>
                            <td>DAST for web apps</td>
                            <td>OWASP Top 10, API scanning, authenticated scanning</td>
                        </tr>
                        <tr>
                            <td><strong>Container Security (CS)</strong></td>
                            <td>Container/Kubernetes security</td>
                            <td>Image scanning, runtime protection, registry integration</td>
                        </tr>
                        <tr>
                            <td><strong>Cloud Security Assessment (CSA)</strong></td>
                            <td>CSPM for cloud</td>
                            <td>AWS, Azure, GCP misconfigurations</td>
                        </tr>
                        <tr>
                            <td><strong>Global IT Asset Inventory (GAV)</strong></td>
                            <td>Asset discovery</td>
                            <td>Complete asset inventory, software inventory, EOL tracking</td>
                        </tr>
                        <tr>
                            <td><strong>Patch Management (PM)</strong></td>
                            <td>Automated patching</td>
                            <td>Patch deployment, scheduling, zero-touch patching</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Cloud Agents -->
                <h2>Cloud Agents Deep Dive</h2>

                <p>Cloud Agents are lightweight software installed on endpoints that continuously collect vulnerability and compliance data. They're the modern approach to vulnerability management, replacing periodic network scans.</p>

                <h3>Agent Architecture</h3>

                <div class="card-grid">
                    <div class="card">
                        <h4>Agent Components</h4>
                        <ul>
                            <li><strong>Manifest:</strong> Defines what data to collect</li>
                            <li><strong>Scanner Engine:</strong> Performs local assessments</li>
                            <li><strong>Data Upload:</strong> Sends results to Qualys cloud</li>
                            <li><strong>Configuration:</strong> Activation key + profile</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>Agent Benefits</h4>
                        <ul>
                            <li>Real-time visibility (no scan windows)</li>
                            <li>Works for roaming/remote devices</li>
                            <li>Lower network impact than scanners</li>
                            <li>Authenticated by design</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>Agent Limitations</h4>
                        <ul>
                            <li>Requires installation on each host</li>
                            <li>Can't scan network devices</li>
                            <li>Memory/CPU footprint (minimal)</li>
                            <li>Needs outbound HTTPS to Qualys</li>
                        </ul>
                    </div>
                </div>

                <h3>Agent Configuration</h3>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Bash</span>
                        <span class="code-title">Linux Agent Installation</span>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <pre><code># Download and install Qualys Cloud Agent (Linux)
# Replace with your activation key and customer ID

ACTIVATION_KEY="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
CUSTOMER_ID="12345678"

# Download installer
curl -o qualys-cloud-agent.rpm \
    "https://qualysguard.qualys.com/CloudAgent/download/rpm/qualys-cloud-agent.x86_64.rpm"

# Install the agent
sudo rpm -ivh qualys-cloud-agent.rpm

# Activate the agent
sudo /usr/local/qualys/cloud-agent/bin/qualys-cloud-agent.sh \
    ActivationId=$ACTIVATION_KEY \
    CustomerId=$CUSTOMER_ID

# Verify agent status
sudo service qualys-cloud-agent status</code></pre>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">PowerShell</span>
                        <span class="code-title">Windows Agent Installation</span>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <pre><code># Download and install Qualys Cloud Agent (Windows)
$ActivationKey = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
$CustomerId = "12345678"
$InstallerPath = "$env:TEMP\QualysCloudAgent.exe"

# Download installer
Invoke-WebRequest -Uri "https://qualysguard.qualys.com/CloudAgent/download/windows/QualysCloudAgent.exe" `
    -OutFile $InstallerPath

# Silent installation with activation
Start-Process -FilePath $InstallerPath -ArgumentList @(
    "CustomerId=$CustomerId",
    "ActivationId=$ActivationKey",
    "/S"  # Silent install
) -Wait

# Verify agent service
Get-Service QualysAgent | Select-Object Name, Status</code></pre>
                </div>

                <h3>Agent Profiles & Configuration</h3>

                <div class="info-box tip">
                    <strong>Best Practice:</strong> Create separate agent profiles for different asset types (servers, workstations, cloud instances). 
                    This allows you to control scan frequency, enabled modules, and performance settings per profile.
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Profile Setting</th>
                            <th>Servers</th>
                            <th>Workstations</th>
                            <th>Cloud Instances</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>VM Scan Interval</strong></td>
                            <td>4 hours</td>
                            <td>24 hours</td>
                            <td>1 hour</td>
                        </tr>
                        <tr>
                            <td><strong>PC Scan Interval</strong></td>
                            <td>Daily</td>
                            <td>Weekly</td>
                            <td>Daily</td>
                        </tr>
                        <tr>
                            <td><strong>Performance Profile</strong></td>
                            <td>Normal</td>
                            <td>Low</td>
                            <td>High</td>
                        </tr>
                        <tr>
                            <td><strong>Blackout Windows</strong></td>
                            <td>Business hours</td>
                            <td>None</td>
                            <td>None</td>
                        </tr>
                    </tbody>
                </table>

                <!-- VMDR -->
                <h2>VMDR: Vulnerability Management</h2>

                <p>VMDR (Vulnerability Management, Detection and Response) is the core vulnerability scanning module. It identifies vulnerabilities, prioritizes them with TruRisk, and tracks remediation.</p>

                <h3>TruRisk Scoring</h3>

                <p>TruRisk is Qualys's risk scoring methodology that goes beyond CVSS to incorporate real-world threat context.</p>

                <div class="card-grid">
                    <div class="card">
                        <h4>TruRisk Factors</h4>
                        <ul>
                            <li><strong>CVSS Score:</strong> Base vulnerability severity</li>
                            <li><strong>Exploit Availability:</strong> Is there a public exploit?</li>
                            <li><strong>Active Exploitation:</strong> Being exploited in the wild?</li>
                            <li><strong>Malware Association:</strong> Used by malware families?</li>
                            <li><strong>Asset Criticality:</strong> Business importance of asset</li>
                            <li><strong>Trending:</strong> Increasing attacker interest?</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>TruRisk Score Ranges</h4>
                        <ul>
                            <li><strong>850-1000:</strong> Critical - Immediate action</li>
                            <li><strong>700-849:</strong> High - Action within 7 days</li>
                            <li><strong>500-699:</strong> Medium - Action within 30 days</li>
                            <li><strong>1-499:</strong> Low - Action within 90 days</li>
                        </ul>
                        <p style="margin-top: 1rem;">Scores are calculated per asset, allowing you to see your total risk exposure.</p>
                    </div>
                </div>

                <h3>QID (Qualys ID) System</h3>

                <p>Every vulnerability in Qualys is identified by a QID. Understanding QID ranges helps quickly categorize findings.</p>

                <table>
                    <thead>
                        <tr>
                            <th>QID Range</th>
                            <th>Category</th>
                            <th>Examples</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>1-9999</strong></td>
                            <td>Information Gathered</td>
                            <td>Open ports, banners, OS detection</td>
                        </tr>
                        <tr>
                            <td><strong>10000-19999</strong></td>
                            <td>Configuration Issues</td>
                            <td>Weak ciphers, default credentials</td>
                        </tr>
                        <tr>
                            <td><strong>20000-89999</strong></td>
                            <td>Vulnerabilities</td>
                            <td>CVE-mapped vulnerabilities</td>
                        </tr>
                        <tr>
                            <td><strong>90000-99999</strong></td>
                            <td>Potential Vulnerabilities</td>
                            <td>Requires manual verification</td>
                        </tr>
                        <tr>
                            <td><strong>100000+</strong></td>
                            <td>Policy Compliance</td>
                            <td>CIS benchmark controls</td>
                        </tr>
                    </tbody>
                </table>

                <!-- API Integration -->
                <h2>Qualys API Integration</h2>

                <p>The Qualys API enables automation, integration with SIEM/SOAR, and custom reporting. Understanding the API is essential for enterprise-scale vulnerability management.</p>

                <h3>API Types</h3>

                <div class="card-grid">
                    <div class="card">
                        <h4>Version 1 API (Legacy)</h4>
                        <ul>
                            <li>XML-based responses</li>
                            <li>Session-based authentication</li>
                            <li>Older modules (VM, PC, WAS)</li>
                            <li>Being deprecated</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>Version 2 API (Current)</h4>
                        <ul>
                            <li>JSON responses</li>
                            <li>Token-based authentication</li>
                            <li>Modern modules (VMDR, CS, GAV)</li>
                            <li>Rate limiting: 300 calls/hour</li>
                        </ul>
                    </div>
                </div>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <span class="code-title">Qualys API - Export Vulnerabilities</span>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <pre><code>import requests
import json
import time
from base64 import b64encode

# Configuration
QUALYS_API = "https://qualysapi.qualys.com"  # Adjust for your platform
USERNAME = "your_username"
PASSWORD = "your_password"

# Create auth header
credentials = b64encode(f"{USERNAME}:{PASSWORD}".encode()).decode()
headers = {
    "Authorization": f"Basic {credentials}",
    "Content-Type": "application/json",
    "X-Requested-With": "Python"
}

def get_vmdr_host_detections(since_days=7):
    """Export host detections from VMDR"""
    
    # Step 1: Initiate export
    export_url = f"{QUALYS_API}/api/2.0/fo/asset/host/vm/detection/"
    params = {
        "action": "list",
        "detection_updated_since": f"{since_days}d",
        "status": "New,Active,Re-Opened",
        "severities": "3,4,5",  # Medium, High, Critical
        "output_format": "JSON"
    }
    
    response = requests.get(export_url, headers=headers, params=params)
    
    if response.status_code == 200:
        data = response.json()
        return data.get("HOST_LIST_VM_DETECTION_OUTPUT", {}).get("HOST_LIST", {})
    else:
        raise Exception(f"API Error: {response.status_code} - {response.text}")

def get_asset_inventory():
    """Get complete asset inventory from GAV"""
    
    url = f"{QUALYS_API}/rest/2.0/search/am/asset"
    payload = {
        "ServiceRequest": {
            "filters": {
                "Criteria": [
                    {"field": "lastVulnScan", "operator": "GREATER", "value": "now-7d"}
                ]
            }
        }
    }
    
    response = requests.post(url, headers=headers, json=payload)
    return response.json()

def export_to_siem(detections):
    """Format vulnerabilities for SIEM ingestion"""
    
    siem_events = []
    for host in detections.get("HOST", []):
        host_ip = host.get("IP", "Unknown")
        hostname = host.get("DNS", host_ip)
        
        for detection in host.get("DETECTION_LIST", {}).get("DETECTION", []):
            event = {
                "timestamp": detection.get("LAST_UPDATE_DATETIME"),
                "source": "qualys_vmdr",
                "severity": detection.get("SEVERITY"),
                "qid": detection.get("QID"),
                "title": detection.get("TITLE"),
                "host_ip": host_ip,
                "hostname": hostname,
                "cvss_base": detection.get("CVSS_BASE"),
                "cvss3_base": detection.get("CVSS3_BASE"),
                "cve_list": detection.get("CVE_ID_LIST", {}).get("CVE_ID", []),
                "status": detection.get("STATUS"),
                "first_found": detection.get("FIRST_FOUND_DATETIME"),
                "last_found": detection.get("LAST_FOUND_DATETIME")
            }
            siem_events.append(event)
    
    return siem_events

# Example usage
if __name__ == "__main__":
    detections = get_vmdr_host_detections(since_days=7)
    siem_events = export_to_siem(detections)
    print(f"Exported {len(siem_events)} vulnerability detections")</code></pre>
                </div>

                <h3>Sentinel Integration</h3>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">KQL</span>
                        <span class="code-title">Query Qualys Data in Sentinel</span>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <pre><code>// Qualys data connector populates QualysHostDetection table
// Critical vulnerabilities from last 24 hours
QualysHostDetection
| where TimeGenerated > ago(24h)
| where Severity >= 4  // High and Critical
| where Status in ("New", "Active", "Re-Opened")
| summarize 
    VulnCount = count(),
    DistinctQIDs = dcount(QID),
    Vulnerabilities = make_set(Title)
    by HostName, HostIP
| sort by VulnCount desc

// Join with TI for exploited vulnerabilities
QualysHostDetection
| where TimeGenerated > ago(7d)
| join kind=inner (
    ThreatIntelligenceIndicator
    | where ExpirationDateTime > now()
    | where ThreatType == "vulnerability"
    | project CVE = tostring(split(Description, ":")[1])
) on $left.CVE == $right.CVE
| project TimeGenerated, HostName, HostIP, QID, Title, CVE, Severity

// Assets not scanned in 7 days (coverage gap)
QualysHostDetection
| summarize LastScan = max(TimeGenerated) by HostName, HostIP
| where LastScan < ago(7d)
| project HostName, HostIP, DaysSinceLastScan = datetime_diff('day', now(), LastScan)</code></pre>
                </div>

                <!-- Policy Compliance -->
                <h2>Policy Compliance (PC)</h2>

                <p>Policy Compliance assesses system configurations against security benchmarks like CIS, DISA STIGs, and custom policies.</p>

                <h3>Supported Frameworks</h3>

                <div class="card-grid">
                    <div class="card">
                        <h4>CIS Benchmarks</h4>
                        <ul>
                            <li>Windows Server 2016/2019/2022</li>
                            <li>Windows 10/11</li>
                            <li>RHEL 7/8/9</li>
                            <li>Ubuntu 18.04/20.04/22.04</li>
                            <li>AWS Foundations</li>
                            <li>Azure Foundations</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>Regulatory</h4>
                        <ul>
                            <li>PCI DSS 3.2.1 / 4.0</li>
                            <li>HIPAA</li>
                            <li>SOX ITGC</li>
                            <li>ISO 27001</li>
                            <li>NIST 800-53</li>
                            <li>GDPR Technical Controls</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h4>Custom Policies</h4>
                        <ul>
                            <li>Organization-specific hardening</li>
                            <li>Application baselines</li>
                            <li>Internal security standards</li>
                            <li>Merge/modify existing policies</li>
                        </ul>
                    </div>
                </div>

                <div class="info-box warning">
                    <strong>PC vs VM:</strong> Policy Compliance checks configurations (is the password policy correct?), 
                    while VMDR finds vulnerabilities (is this CVE present?). Both are needed for comprehensive security assessment.
                </div>

                <!-- Container Security -->
                <h2>Container Security (CS)</h2>

                <p>Qualys Container Security provides vulnerability assessment for container images and runtime protection for Kubernetes environments.</p>

                <h3>Container Scanning Workflow</h3>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">YAML</span>
                        <span class="code-title">Jenkins Pipeline with Qualys Scan</span>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <pre><code>pipeline {
    agent any
    
    environment {
        QUALYS_API_URL = 'https://qualysapi.qualys.com'
        QUALYS_CREDS = credentials('qualys-api-credentials')
        IMAGE_NAME = 'myapp'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
    }
    
    stages {
        stage('Build') {
            steps {
                sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
            }
        }
        
        stage('Qualys Container Scan') {
            steps {
                // Install Qualys Container Sensor if not present
                sh '''
                    docker pull qualys/qcs-sensor:latest
                    
                    # Scan the built image
                    docker run --rm \
                        -v /var/run/docker.sock:/var/run/docker.sock \
                        -e QUALYS_API_SERVER=${QUALYS_API_URL} \
                        -e QUALYS_USERNAME=${QUALYS_CREDS_USR} \
                        -e QUALYS_PASSWORD=${QUALYS_CREDS_PSW} \
                        qualys/qcs-sensor scan \
                        --image ${IMAGE_NAME}:${IMAGE_TAG} \
                        --fail-on-severity 4
                '''
            }
        }
        
        stage('Push to Registry') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                sh "docker push registry.example.com/${IMAGE_NAME}:${IMAGE_TAG}"
            }
        }
    }
    
    post {
        failure {
            slackSend channel: '#security-alerts',
                message: "Container scan failed for ${IMAGE_NAME}:${IMAGE_TAG}"
        }
    }
}</code></pre>
                </div>

                <!-- Reporting & Metrics -->
                <h2>Reporting & Metrics</h2>

                <h3>Key Vulnerability Metrics</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Formula</th>
                            <th>Target</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>MTTR (Mean Time to Remediate)</strong></td>
                            <td>Average days from detection to fix</td>
                            <td>Critical: 7d, High: 30d, Medium: 90d</td>
                        </tr>
                        <tr>
                            <td><strong>Scan Coverage</strong></td>
                            <td>Assets scanned / Total assets × 100</td>
                            <td>>95%</td>
                        </tr>
                        <tr>
                            <td><strong>Vulnerability Density</strong></td>
                            <td>Vulnerabilities / Assets</td>
                            <td>Decreasing trend</td>
                        </tr>
                        <tr>
                            <td><strong>Overdue Vulns</strong></td>
                            <td>Vulns past SLA / Total vulns × 100</td>
                            <td><5%</td>
                        </tr>
                        <tr>
                            <td><strong>TruRisk Score</strong></td>
                            <td>Aggregate risk across all assets</td>
                            <td>Decreasing trend</td>
                        </tr>
                    </tbody>
                </table>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">Python</span>
                        <span class="code-title">Generate VM Metrics Report</span>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <pre><code>import pandas as pd
from datetime import datetime, timedelta

def calculate_vm_metrics(detections_df):
    """Calculate key vulnerability management metrics"""
    
    metrics = {}
    
    # MTTR by severity
    remediated = detections_df[detections_df['status'] == 'Fixed']
    remediated['remediation_days'] = (
        pd.to_datetime(remediated['fixed_date']) - 
        pd.to_datetime(remediated['first_found'])
    ).dt.days
    
    metrics['mttr_critical'] = remediated[
        remediated['severity'] == 5
    ]['remediation_days'].mean()
    
    metrics['mttr_high'] = remediated[
        remediated['severity'] == 4
    ]['remediation_days'].mean()
    
    # Open vulnerabilities by severity
    open_vulns = detections_df[
        detections_df['status'].isin(['New', 'Active', 'Re-Opened'])
    ]
    
    metrics['open_critical'] = len(open_vulns[open_vulns['severity'] == 5])
    metrics['open_high'] = len(open_vulns[open_vulns['severity'] == 4])
    metrics['open_medium'] = len(open_vulns[open_vulns['severity'] == 3])
    
    # SLA compliance (Critical = 7d, High = 30d, Medium = 90d)
    today = datetime.now()
    sla_days = {5: 7, 4: 30, 3: 90}
    
    overdue = 0
    for severity, days in sla_days.items():
        sla_date = today - timedelta(days=days)
        overdue += len(open_vulns[
            (open_vulns['severity'] == severity) &
            (pd.to_datetime(open_vulns['first_found']) < sla_date)
        ])
    
    metrics['overdue_count'] = overdue
    metrics['sla_compliance'] = (
        1 - (overdue / len(open_vulns))
    ) * 100 if len(open_vulns) > 0 else 100
    
    # Vulnerability density
    unique_hosts = detections_df['host_ip'].nunique()
    metrics['vuln_density'] = len(open_vulns) / unique_hosts
    
    return metrics</code></pre>
                </div>

                <!-- Interview Questions -->
                <h2>Interview Questions & Answers</h2>

                <div class="expandable">
                    <div class="expandable-header">
                        <span>Q: What's the difference between Cloud Agents and network scanning?</span>
                        <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="expandable-content">
                        <p><strong>Cloud Agents:</strong></p>
                        <ul>
                            <li>Installed locally on each host</li>
                            <li>Continuous assessment (near real-time)</li>
                            <li>Works for roaming/remote devices</li>
                            <li>Authenticated by design (local access)</li>
                            <li>Can't scan network devices (routers, firewalls)</li>
                        </ul>
                        <p><strong>Network Scanning:</strong></p>
                        <ul>
                            <li>Scanner appliance probes network targets</li>
                            <li>Scheduled scans (periodic assessment)</li>
                            <li>Requires network line-of-sight</li>
                            <li>Unauthenticated or requires stored credentials</li>
                            <li>Can scan anything with an IP (including network devices)</li>
                        </ul>
                        <p><strong>Best Practice:</strong> Use Cloud Agents for servers and workstations, network scanners for network devices and periodic external scanning.</p>
                    </div>
                </div>

                <div class="expandable">
                    <div class="expandable-header">
                        <span>Q: How does TruRisk differ from CVSS scoring?</span>
                        <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="expandable-content">
                        <p><strong>CVSS (Common Vulnerability Scoring System):</strong></p>
                        <ul>
                            <li>Static score assigned when CVE is published</li>
                            <li>Based on theoretical impact and exploitability</li>
                            <li>Doesn't change over time</li>
                            <li>Doesn't consider your specific environment</li>
                        </ul>
                        <p><strong>TruRisk:</strong></p>
                        <ul>
                            <li>Dynamic score that changes based on threat landscape</li>
                            <li>Incorporates real-world exploitation data (Exploit DB, in-the-wild attacks)</li>
                            <li>Considers asset criticality (business context)</li>
                            <li>Factors in malware association</li>
                            <li>Updates as threat intelligence changes</li>
                        </ul>
                        <p><strong>Example:</strong> A vulnerability might have CVSS 7.5 but TruRisk 950 because there's active exploitation in the wild. Another might have CVSS 9.0 but TruRisk 400 because no exploit exists.</p>
                    </div>
                </div>

                <div class="expandable">
                    <div class="expandable-header">
                        <span>Q: How would you integrate Qualys with your SIEM?</span>
                        <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="expandable-content">
                        <p><strong>Integration Methods:</strong></p>
                        <ol>
                            <li><strong>Native Connector (Sentinel):</strong> Built-in data connector pulls QualysHostDetection data automatically</li>
                            <li><strong>API Pull:</strong> Script that queries Qualys API and sends to SIEM (HTTP Event Collector for Splunk, Data Collector API for Sentinel)</li>
                            <li><strong>Qualys Connector App:</strong> Pre-built apps in Splunkbase or Azure Marketplace</li>
                        </ol>
                        <p><strong>Use Cases in SIEM:</strong></p>
                        <ul>
                            <li>Correlate vulnerabilities with active attacks (critical vuln + external access attempt)</li>
                            <li>Risk-based alerting (alert when high-risk vuln found on crown jewel asset)</li>
                            <li>Compliance dashboards (PCI systems with failed controls)</li>
                            <li>SLA tracking (vulnerabilities past remediation deadline)</li>
                        </ul>
                    </div>
                </div>

                <div class="expandable">
                    <div class="expandable-header">
                        <span>Q: What's your approach to prioritizing vulnerabilities?</span>
                        <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="expandable-content">
                        <p><strong>Multi-Factor Prioritization Framework:</strong></p>
                        <ol>
                            <li><strong>Exploitability:</strong>
                                <ul>
                                    <li>Active exploitation (CISA KEV) = Highest priority</li>
                                    <li>Public exploit available = High priority</li>
                                    <li>Proof-of-concept only = Medium</li>
                                    <li>No known exploit = Lower</li>
                                </ul>
                            </li>
                            <li><strong>Asset Context:</strong>
                                <ul>
                                    <li>Internet-facing systems = Higher risk</li>
                                    <li>Crown jewel applications = Higher business impact</li>
                                    <li>Production vs. development</li>
                                </ul>
                            </li>
                            <li><strong>Data Sensitivity:</strong>
                                <ul>
                                    <li>Systems with PII/PHI/PCI data = Higher priority</li>
                                </ul>
                            </li>
                            <li><strong>Compensating Controls:</strong>
                                <ul>
                                    <li>Network segmentation may reduce effective risk</li>
                                    <li>EDR/WAF may provide detection layer</li>
                                </ul>
                            </li>
                        </ol>
                        <p>In Qualys, use TruRisk + Asset Tags to implement this. Create asset groups for crown jewels and internet-facing systems, then prioritize accordingly.</p>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="page-nav">
                    <a href="fundamentals.html" class="nav-btn prev">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        VM Fundamentals
                    </a>
                    <a href="tenable-nessus.html" class="nav-btn next">
                        Tenable/Nessus
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script src="../../js/sidebar.js"></script>
</body>
</html>
